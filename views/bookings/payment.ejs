<% layout('layouts/boilerplate') -%>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<div class="row">
    <div class="col-lg-6 mx-auto"> 
        <h3 class="heading">Booking Summary</h3>

        <div class="summary-card">
           
            <div class="listing-preview d-flex">
                <img src="<%= listing.image.url %>" alt="<%= listing.title %>" class="rounded" style="width: 100px; height: 100px; object-fit: cover;">
                <div class="details ms-3">
                    <h4 class="mb-0"><%= listing.title %></h4>
                    <p class="text-muted small mb-0"><%= listing.location %></p>
                    <span class="small text-muted"><i class="fa-solid fa-star"></i> 4.95 (19)</span>
                </div>
            </div>

            <hr>
            
            <h6 class="mb-1 small">Free cancellation</h6>
            <p class="small text-muted mb-3">
                  <% 
                      // 1. Convert checkInDate string to a Date object
                     const checkIn = new Date(bookingDetails.checkInDate);
                       // 2. Subtract 2 days (2 * 24 * 60 * 60 * 1000 milliseconds)
                      const cancellationDate = new Date(checkIn.getTime() - (2 * 86400000));
                   %>
                       Cancel before <%= cancellationDate.toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' }) %> for a full refund. <a href="#" class="text-dark text-decoration-underline">Full policy</a>
                   </p>
            

            <hr>

            <h6 class="mb-3 small">Dates</h6>
            <div class="d-flex justify-content-between small mb-3">
                <p class="mb-0"><%= new Date(bookingDetails.checkInDate).toLocaleDateString('en-US', { day: 'numeric', month: 'short' }) %> - <%= new Date(bookingDetails.checkOutDate).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' }) %></p>
                <a href="/listings/<%= listing._id %>" class="text-dark text-decoration-underline small">Change</a>
            </div>
            
            <h6 class="mb-3 small">Guests</h6>
            <div class="d-flex justify-content-between small mb-3">
                <p class="mb-0"><%= bookingDetails.guests %> adult(s)</p>
                <a href="/listings/<%= listing._id %>" class="text-dark text-decoration-underline small">Change</a>
            </div>

            <hr>
            
            <h6 class="mb-3 small">Price details</h6>
            
            <div class="d-flex justify-content-between small">
                <span>â‚¹<%= listing.price.toLocaleString("en-IN") %> x <%= numberOfNights %> nights</span>
                <strong>â‚¹<%= subTotal.toLocaleString("en-IN") %></strong>
            </div>

            <div class="d-flex justify-content-between small">
                <span>Taxes (18% GST)</span>
                <strong>â‚¹<%= gstAmount.toLocaleString("en-IN") %></strong>
            </div>

            <hr>

            <div class="d-flex justify-content-between">
                <h6 class="small"><b>Total INR</b></h6>
                <strong>â‚¹<%= finalPrice.toLocaleString("en-IN") %></strong>
            </div>

            <hr class="mt-4">

            <button id="pay-now-button" class="btn btn-danger w-100" type="button">
                Agree and Pay â‚¹<%= finalPrice.toLocaleString("en-IN") %>
            </button>
            
            <input type="hidden" id="listing-id" value="<%= listing._id %>">
            <input type="hidden" id="check-in-date" value="<%= bookingDetails.checkInDate %>">
            <input type="hidden" id="check-out-date" value="<%= bookingDetails.checkOutDate %>">
            <input type="hidden" id="guests" value="<%= bookingDetails.guests %>">

        </div>
    </div>
</div>
<br>
<br>

<script>
    // Extract variables from hidden inputs
    const listingId = document.getElementById('listing-id').value;
    const checkInDate = document.getElementById('check-in-date').value;
    const checkOutDate = document.getElementById('check-out-date').value;
    const guests = document.getElementById('guests').value;

    document.getElementById("pay-now-button").onclick = async function (e) {
        e.preventDefault();

        // ðŸ”µ 1. Create order on backend (using the correct route: /listings/:id/create-order)
        const orderResponse = await fetch(`/listings/${listingId}/create-order`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                checkInDate: checkInDate,
                checkOutDate: checkOutDate,
                guests: guests
            })
        });

        if (!orderResponse.ok) {
            const error = await orderResponse.json();
            alert(`Error creating payment order: ${error.error || 'Unknown server error'}`);
            return;
        }

        const order = await orderResponse.json();

        // ðŸ”µ 2. Open Razorpay popup
        const options = {
            // ** CORRECT ACCESS: Use the variable passed from the controller, not process.env **
            key: "<%= razorpayKeyId %>", 
            amount: order.amount, // Amount in paisa
            currency: "INR",
            name: "<%= listing.title %>",
            description: "Booking Reservation",
            image: "<%= listing.image.url %>",
            order_id: order.id, 
            handler: function (response) {

                // ðŸ”µ 3. Verify payment on backend by submitting the form 
                // This targets your createBooking route: /listings/:id/reservations
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/listings/${listingId}/reservations`; 

                // Send booking details and payment proof as hidden inputs
                const dataToSend = [
                    // Booking data (must be named as booking[field] for server to read it)
                    { name: 'booking[checkInDate]', value: checkInDate },
                    { name: 'booking[checkOutDate]', value: checkOutDate },
                    { name: 'booking[guests]', value: guests },
                    // Razorpay Payment Proof
                    { name: 'razorpay_payment_id', value: response.razorpay_payment_id },
                    { name: 'razorpay_order_id', value: response.razorpay_order_id },
                    { name: 'razorpay_signature', value: response.razorpay_signature }
                ];

                dataToSend.forEach(item => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = item.name;
                    input.value = item.value;
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit(); 
            },
            prefill: {
                name: "<%= currUser.username || '' %>", 
                email: "<%= currUser.email || '' %>", 
                contact: ""
            },
            theme: { color: "#ff385c" }
        };

        const rzp = new Razorpay(options);
        rzp.on('payment.failed', function (response){
            alert("Payment Failed: " + response.error.description);
        });
        rzp.open();
    };
</script> 